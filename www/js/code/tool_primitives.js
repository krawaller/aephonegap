(function(){var Err,FindSubLists,Fraction,Neg,NotEqual,Num,OK,Power,Prod,Product,Sum,UNDEFINED,analyseVarKids,collapseStubList,contains,copy,decNumToFrac,deepcopy,equal,exchangeChild,exportTo,find,findAllPathsTo,findHole,findPathTo,fixAssumptionPath,flatSortString,flipRel,fracToDecNum,fracWithNegNumToDecNum,fullSortString,funcs,getSpiritObj,getStraightFacAddress,integerifyDecNumsInFrac,isKindredSpirits,isOK,isWholeNumber,k,lookUp,makeEqual,mixin,negAnalysis,negStrip,one,pathToChoice,printObj,reads,rearrangeFacs,rearrangeInCon,rearrangeInDis,rearrangeTerms,reorderInstruction,sortOrder,undefChildObjToUndef,v,weight,x,y,z,zero,_ref,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};_ref=typeof require==="undefined"?this.CATS.math.toolhelpers:require("./toolhelpers"),flipRel=_ref.flipRel,fixAssumptionPath=_ref.fixAssumptionPath,UNDEFINED=_ref.UNDEFINED,deepcopy=_ref.deepcopy,mixin=_ref.mixin,x=_ref.x,y=_ref.y,z=_ref.z,reads=_ref.reads,Neg=_ref.Neg,Product=_ref.Product,Sum=_ref.Sum,Power=_ref.Power,Fraction=_ref.Fraction,NotEqual=_ref.NotEqual,Num=_ref.Num,Prod=_ref.Prod,Sum=_ref.Sum,zero=_ref.zero,one=_ref.one,Err=_ref.Err,OK=_ref.OK,printObj=_ref.printObj;weight=function(obj){var child,w,_i,_len,_ref1;if(!obj.objs){return 1}else{w=0;_ref1=obj.objs;for(_i=0,_len=_ref1.length;_i<_len;_i++){child=_ref1[_i];w+=weight(child)}return w}};analyseVarKids=function(obj){var diver,val,_results;diver=function(obj,coll){var child,_i,_len,_ref1;if(obj.type==="variable"){coll[obj.val]=true}else if(obj.objs){_ref1=obj.objs;for(_i=0,_len=_ref1.length;_i<_len;_i++){child=_ref1[_i];coll=diver(child,coll)}}return coll};_results=[];for(val in diver(obj,{})){_results.push({type:"variable",val:val})}return _results};isKindredSpirits=function(_arg){var child1,child1negs,child2,child2negs,childnum,deps,err,i,kidnums,obj1,obj1child,obj1inneraddr,obj2,obj2child,obj2inneraddr,p,ret,s1,s1denom,s1inneraddr,s1left,s1numer,s1realchildnegpos,s1right,s1totalneg,s2,s2denom,s2inneraddr,s2left,s2numer,s2realchildnegpos,s2right,s2totalneg,trykids,_i,_j,_k,_l,_m,_n,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9;obj1=_arg.obj1,obj2=_arg.obj2,deps=_arg.deps;s1=deps.getSpiritObj(obj1);s2=deps.getSpiritObj(obj2);s1inneraddr=[];for(i=_i=0,_ref1=s1.neganalysis.negs;0<=_ref1?_i<_ref1:_i>_ref1;i=0<=_ref1?++_i:--_i){s1inneraddr.push(0)}s2inneraddr=[];for(i=_j=0,_ref2=s2.neganalysis.negs;0<=_ref2?_j<_ref2:_j>_ref2;i=0<=_ref2?++_j:--_j){s2inneraddr.push(0)}ret={first:s1,second:s2};err=false;if(s1.spirit.type!==s2.spirit.type){err="differenttypes"}else if(s1.spirit.type==="fraction"&&s2.spirit.type==="fraction"){s1numer=deps.getSpiritObj(deps.lookUp(obj1,s1inneraddr.concat(0)));s1denom=deps.getSpiritObj(deps.lookUp(obj1,s1inneraddr.concat(1)));s2numer=deps.getSpiritObj(deps.lookUp(obj2,s2inneraddr.concat(0)));s2denom=deps.getSpiritObj(deps.lookUp(obj2,s2inneraddr.concat(1)));s1totalneg=s1.neganalysis.totalnegs+s1numer.neganalysis.childnegcount+s1denom.neganalysis.childnegcount;s2totalneg=s2.neganalysis.totalnegs+s2numer.neganalysis.childnegcount+s2denom.neganalysis.childnegcount;if(s1totalneg!==s2totalneg){err="differenttotalnegcounts"}else if(!deps.equal(s1numer.spirit,s2numer.spirit)){err="differentnumerspirits"}else if(!deps.equal(s1denom.spirit,s2denom.spirit)){err="differentdenomspirits"}else if(s1numer.spirit.type!=="product"&&s1numer.neganalysis.childnegcount!==s2numer.neganalysis.childnegcount){err="differentnonprodnumerinnernegcount"}else if(s1denom.spirit.type!=="product"&&s1denom.neganalysis.childnegcount!==s2denom.neganalysis.childnegcount){err="differentnonproddenominnernegcount"}ret=mixin({s1numer:s1numer,s1denom:s1denom,s2numer:s2numer,s2denom:s2denom},ret)}else if(s1.spirit.type==="relation"&&s2.spirit.type==="relation"){if(s1.spirit.val!==s2.spirit.val){err="differentrelationtypes"}else{if((_ref3=obj1.val)==="eq"||_ref3==="neq"){s1left=obj1.objs[s1.reorder[0]];s1right=obj1.objs[s1.reorder[1]]}else{s1left=obj1.objs[s1.spirit.val===obj1.val?0:1];s1right=obj1.objs[s1.spirit.val===obj1.val?1:0]}if((_ref4=obj2.val)==="eq"||_ref4==="neq"){s2left=obj2.objs[s2.reorder[0]];s2right=obj2.objs[s2.reorder[1]]}else{s2left=obj2.objs[s1.spirit.val===obj2.val?0:1];s2right=obj2.objs[s1.spirit.val===obj2.val?1:0]}if(!deps.isKindredSpirits({obj1:s1left,obj2:s2left,deps:deps}).result){err="differentleftsides"}else if(!deps.isKindredSpirits({obj1:s1right,obj2:s2right,deps:deps}).result){err="differentrightsides"}}}else if((_ref5=s1.spirit.type)==="product"||_ref5==="sum"||_ref5==="AND"||_ref5==="OR"||_ref5==="XOR"){if(s1.spirit.objs.length!==s2.spirit.objs.length){err="differentchildcounts"}else{for(childnum=_k=0,_ref6=s1.spirit.objs.length;0<=_ref6?_k<_ref6:_k>_ref6;childnum=0<=_ref6?++_k:--_k){if(!!err){continue}child1=s1.spirit.objs[childnum];child1negs=s1.neganalysis.childnegs[s1.reorder[childnum]];child2=s2.spirit.objs[childnum];child2negs=s2.neganalysis.childnegs[s2.reorder[childnum]];trykids=deps.isKindredSpirits({obj1:child1,obj2:child2,deps:deps});if(trykids.result===false){err="differentlistkidpair"}}}if(!err){if(s1.neganalysis.totalnegs!==s2.neganalysis.totalnegs){err="differentnegcounts"}else if(s1.spirit.type!=="product"){s1realchildnegpos=function(){var _l,_len,_ref7,_results;_ref7=s1.reorder;_results=[];for(_l=0,_len=_ref7.length;_l<_len;_l++){p=_ref7[_l];_results.push(s1.neganalysis.childnegs[p])}return _results}();s2realchildnegpos=function(){var _l,_len,_ref7,_results;_ref7=s2.reorder;_results=[];for(_l=0,_len=_ref7.length;_l<_len;_l++){p=_ref7[_l];_results.push(s2.neganalysis.childnegs[p])}return _results}();if(!(s1realchildnegpos.join("X")===s2realchildnegpos.join("X"))){err="differentnegpositions"}}}}else{if(s1.neganalysis.negs!==s2.neganalysis.negs){err="differentenvelopnegcount"}else if(s1.spirit.val!==s2.spirit.val){err="differentvalues"}else{kidnums=(_ref7=s1.spirit.objs)!=null?_ref7.length:void 0;if(kidnums){obj1inneraddr=[];for(i=_l=0,_ref8=s1.neganalysis.negs;0<=_ref8?_l<_ref8:_l>_ref8;i=0<=_ref8?++_l:--_l){obj1inneraddr.push(0)}obj2inneraddr=[];for(i=_m=0,_ref9=s2.neganalysis.negs;0<=_ref9?_m<_ref9:_m>_ref9;i=0<=_ref9?++_m:--_m){obj2inneraddr.push(0)}for(childnum=_n=0;0<=kidnums?_n<kidnums:_n>kidnums;childnum=0<=kidnums?++_n:--_n){if(!!err){continue}obj1child=deps.lookUp(obj1,obj1inneraddr.concat(childnum));obj2child=deps.lookUp(obj2,obj2inneraddr.concat(childnum));trykids=deps.isKindredSpirits({obj1:obj1child,obj2:obj2child,deps:deps});if(trykids.result===false){err="differentkidpair"}}}}}ret.result=!err;ret.comment=err;return ret};flatSortString=function(obj){return obj.type+(obj.val?"-"+obj.val:"")+(obj.objs?"-"+obj.objs.length:"")};fullSortString=function(obj){var child,mystr,_i,_len,_ref1;mystr=flatSortString(obj);if(obj.objs){_ref1=obj.objs;for(_i=0,_len=_ref1.length;_i<_len;_i++){child=_ref1[_i];mystr+="_"+flatSortString(child)}}return mystr};sortOrder=function(objs){var arr,mystr,n,obj,record,s,_i,_j,_len,_len1,_ref1,_results;arr=[];record={};for(n=_i=0,_len=objs.length;_i<_len;n=++_i){obj=objs[n];mystr=fullSortString(obj);while(record.hasOwnProperty(mystr)){mystr+="X"}arr.push(mystr);record[mystr]=n}_ref1=arr.sort();_results=[];for(_j=0,_len1=_ref1.length;_j<_len1;_j++){s=_ref1[_j];_results.push(record[s])}return _results};getSpiritObj=function(obj){var neganalysis,newpos,oldpos,reorder,spirit,_i,_j,_len,_len1,_ref1,_ref2,_ref3;neganalysis=negAnalysis(obj);spirit=deepcopy(neganalysis.obj);if((_ref1=spirit.type)==="sum"||_ref1==="product"||_ref1==="AND"||_ref1==="OR"||_ref1==="XOR"||spirit.type==="relation"&&((_ref2=spirit.val)==="eq"||_ref2==="neq")){reorder=sortOrder(spirit.objs||[]);for(newpos=_i=0,_len=reorder.length;_i<_len;newpos=++_i){oldpos=reorder[newpos];spirit.objs[newpos]=neganalysis.obj.objs[oldpos]}}if(spirit.type==="relation"&&spirit.val[0]==="g"){_ref3=[1,0];for(newpos=_j=0,_len1=_ref3.length;_j<_len1;newpos=++_j){oldpos=_ref3[newpos];spirit.objs[newpos]=neganalysis.obj.objs[oldpos];spirit.val="l"+spirit.val.slice(1)}}return{spirit:spirit,neganalysis:neganalysis,reorder:reorder}};negStrip=function(obj){var negs;negs=0;while(obj.type==="negation"){negs++;obj=obj.objs[0]}return[obj,negs]};negAnalysis=function(obj){var child,childnegs,childnum,me,mynegs,ret,strippedchild,_i,_len,_ref1,_ref2,_ref3;_ref1=negStrip(obj),me=_ref1[0],mynegs=_ref1[1];ret={obj:deepcopy(me),negs:mynegs,totalnegs:mynegs,childnegs:[],childnegcount:0};if(ret.obj.objs){_ref2=ret.obj.objs;for(childnum=_i=0,_len=_ref2.length;_i<_len;childnum=++_i){child=_ref2[childnum];_ref3=negStrip(child),strippedchild=_ref3[0],childnegs=_ref3[1];ret.obj.objs[childnum]=strippedchild;ret.childnegs[childnum]=childnegs;ret.totalnegs+=childnegs;ret.childnegcount+=childnegs}}return ret};reorderInstruction=function(spirit1,spirit2){var pos,_i,_len,_results;_results=[];for(_i=0,_len=spirit1.length;_i<_len;_i++){pos=spirit1[_i];_results.push(spirit2[pos])}return _results};isOK=function(o){return o===OK};collapseStubList=function(o){if(o.objs.length===1){return o.objs[0]}else{return o}};copy=function(o){var c,p,res,v;res={};for(p in o){v=o[p];if(p==="type"||p==="val"){res[p]=v}}if(!!o.objs){res.objs=function(){var _i,_len,_ref1,_results;_ref1=o.objs;_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){c=_ref1[_i];_results.push(copy(c))}return _results}()}return res};lookUp=function(o,addr,assuming,moronic){if(!o){throw"Looking up in thin air, you moron! ["+addr.join(",")+"] "+assuming+moronic}if(assuming){addr=fixAssumptionPath(o,addr,assuming).aim}if(addr.length){if(!o.objs){return 0}return lookUp(o.objs[addr[0]],addr.slice(1),false,moronic||assuming)}else{return o}};exchangeChild=function(o,newchild,addr){var losingParent;o=deepcopy(o);newchild=deepcopy(newchild);if(!addr.length){o=newchild}else{losingParent=lookUp(o,addr.slice(0,-1));losingParent.objs[addr[addr.length-1]]=newchild}return o};find=function(arr,obj){var at,o,pos,_i,_len;if(arr.objs){arr=arr.objs}at=[];for(pos=_i=0,_len=arr.length;_i<_len;pos=++_i){o=arr[pos];if(equal(o,obj)){at.push(pos)}}return at};getStraightFacAddress=function(stackobj,needleobj,assuming){var choice,path;path=findPathTo(stackobj,needleobj);if(path){choice=pathToChoice(stackobj,path,true);if(choice){return[choice,path.length===0?0:path[path.length-1]]}}};findPathTo=function(stackobj,needleobj,path){var child,look,pos,_i,_len,_ref1;if(path==null){path=[]}if(equal(stackobj,needleobj)){return path}else{if(stackobj.objs){_ref1=stackobj.objs;for(pos=_i=0,_len=_ref1.length;_i<_len;pos=++_i){child=_ref1[pos];look=findPathTo(child,needleobj,path.concat([pos]));if(look){return look}}}return false}};findAllPathsTo=function(stackobj,needleobj,path,found){var child,pos,_i,_len,_ref1;if(path==null){path=[]}if(found==null){found=[]}if(equal(stackobj,needleobj)){found.push(path)}else{if(stackobj.objs){_ref1=stackobj.objs;for(pos=_i=0,_len=_ref1.length;_i<_len;pos=++_i){child=_ref1[pos];found=findAllPathsTo(child,needleobj,path.concat([pos]),found)}}}return found};pathToChoice=function(obj,path,straightfac){var bit,bitnum,builder,names,ok,str,straightnames,use;builder=function(m,arr){return[[m.type,arr[0]]].concat(arr.length?builder(m.objs[arr[0]],arr.slice(1)):[])};names={product:"facs",fraction0:"numer",fraction1:"denom",negation0:"negchild",power0:"powbase"};straightnames={product:"facs",fraction0:"numer",negation0:"negchild"};ok={denomself:"denomself",denomfacsself:"denomfacs",denomnegchildself:"denomnegchild",denomnegchildfacsself:"denomnegchildfacs",facspowbaseself:"facpowbase",facsself:"facs",numerself:"numerself",numerfacsself:"numerfacs",numernegchildself:"numernegchild",numernegchildfacsself:"numernegchildfacs",numernegchildfacspowbaseself:"numernegchildfacpowbase",negchildfacsself:"negchildfacs",negchildfacspowbaseself:"negchildfacpowbase",negchildself:"negchild",negchilddenomfacsself:"negchilddenomfacs",negchilddenomself:"negchilddenomself",negchildnumerfacsself:"negchildnumerfacs",negchildnumerfacspowbaseself:"negchildnumerfacpowbase",negchildnumerself:"negchildnumerself",negchildpowbaseself:"negchildpowbase",powbaseself:"powbase",self:"self"};use=straightfac?straightnames:names;path=builder(obj,path);str=function(){var _i,_len,_results;_results=[];for(bitnum=_i=0,_len=path.length;_i<_len;bitnum=++_i){bit=path[bitnum];_results.push(bit[1]===void 0?"self":use[bit[0]]||use[bit[0]+bit[1]]||"[ERR"+bit[0]+bit[1]+"]")}return _results}().join("");if(!ok[str]){console.log("UNKNOWN!",str)}return ok[str]||false};contains=function(stack,needle){if(stack.objs){stack=stack.objs}return find(stack,needle).length};FindSubLists=function(fn){return function(objs){var me,o,o2,pos,pos2,ret,used,_i,_j,_len,_len1;ret=[];used=[];for(pos=_i=0,_len=objs.length;_i<_len;pos=++_i){o=objs[pos];if(__indexOf.call(used,pos)<0){me=[];for(pos2=_j=0,_len1=objs.length;_j<_len1;pos2=++_j){o2=objs[pos2];if(pos2>pos){if(__indexOf.call(used,pos2)<0){if(fn(o,o2)){me.push(pos2);used.push(pos2)}}}}if(me.length){used.push(pos);me.push(pos);ret.push(me.sort())}}}return ret}};equal=function(o1,o2){var i,o1c,_i,_len,_ref1;if(o1.type!==o2.type){return false}if(o1.val!==o2.val){return false}if(o1.objs){if(o1.objs.length!==o2.objs.length){return false}_ref1=o1.objs;for(i=_i=0,_len=_ref1.length;_i<_len;i=++_i){o1c=_ref1[i];if(!equal(o1c,o2.objs[i])){return false}}}return true};isWholeNumber=function(obj){var val;val=parseFloat(obj.val);return val===Math.floor(val)};findHole=function(fillinto,compareto){var pos,_i,_ref1;for(pos=_i=0,_ref1=fillinto.length;0<=_ref1?_i<_ref1:_i>_ref1;pos=0<=_ref1?++_i:--_i){if(fillinto[pos]<compareto[pos]){return pos}}throw"FOUND NO HOLE"};makeEqual={info:{name:"makeEqual",effect:"rephrasing",example:{str:"(x*-y)/-(y*x)",hunt:[[0],[1]]},uses:["moveNegFromFracToFloorFac","moveNegFromFloorFacToFrac","moveNegBetweenFloorsInFrac","rearrangeTerms","rearrangeFacs","rearrangeInCon","rearrangeInDis","moveNegFromProdToFac","moveNegBetweenFacs","makeEqual","flipRelation"],circle:["makeEqual","flipRelation"],tags:[],lesson:"factorise"},prints:{errors:["mustelectkindredobjects","movenegfromfloortofrac"],steps:["movenegfromfractofloor","reorderinglisttomatch","movenegbetweenfloors","reorderinglisttomatch","movingneginprodtomatch","makesameposchildrensame"]},target:{type:"all",validate:function(o){var id,victim,victims,_i,_len,_ref1;({validate:function(o){}});victims=function(){var _i,_len,_ref1,_results;_ref1=o.hunt;_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){id=_ref1[_i];_results.push(o.deps.lookUp(o.target,id))}return _results}();_ref1=victims.slice(1);for(_i=0,_len=_ref1.length;_i<_len;_i++){victim=_ref1[_i];if(!o.deps.isKindredSpirits(mixin({obj1:victim,obj2:victims[0]},o)).result){return Err("mustelectkindredobjects")}}return OK}},hunt:{questions:[{},{}]},perform:function(o){var analysis,aspir,blueprint,blueprintaddr,blueprintinneraddr,childnum,fromfloor,fromword,hisdenomneg,hisfloorneg,hisfromfloorneg,hisneg,hisnumerneg,histofloorneg,i,id,inneraddr,innervictimobj,instr,kidcount,moveto,movetofac,mydenomneg,myfloorneg,myfromfloorneg,myneg,mynumerneg,mytofloorneg,n,newarr,newnegmap,oldnegmap,p,pos,rearrtool,safety,stealfromfac,takefrom,tofloor,toword,vicn,victim,victimaddr,victims,_i,_j,_k,_l,_len,_len1,_len2,_m,_n,_o,_p,_ref1,_ref10,_ref11,_ref12,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9;_ref1=o.hunt;for(_i=0,_len=_ref1.length;_i<_len;_i++){id=_ref1[_i];o.beforemark(id);o.aftermark(id)}victims=function(){var _j,_len1,_ref2,_results;_ref2=o.hunt;_results=[];for(_j=0,_len1=_ref2.length;_j<_len1;_j++){id=_ref2[_j];_results.push(o.deps.lookUp(o.target,id))}return _results}();blueprint=victims[0];blueprintaddr=o.hunt[0];_ref2=victims.slice(1);for(vicn=_j=0,_len1=_ref2.length;_j<_len1;vicn=++_j){victim=_ref2[vicn];victimaddr=o.hunt[vicn+1];if(!o.deps.equal(victim,blueprint)){analysis=o.deps.isKindredSpirits(mixin({obj1:blueprint,obj2:victim},o));myneg=analysis.second.neganalysis;hisneg=analysis.first.neganalysis;inneraddr=deepcopy(victimaddr);for(i=_k=0,_ref3=analysis.second.neganalysis.negs;0<=_ref3?_k<_ref3:_k>_ref3;i=0<=_ref3?++_k:--_k){inneraddr.push(0)}blueprintinneraddr=deepcopy(o.hunt[0]);for(i=_l=0,_ref4=analysis.second.neganalysis.negs;0<=_ref4?_l<_ref4:_l>_ref4;i=0<=_ref4?++_l:--_l){blueprintinneraddr.push(0)}if(!analysis.result){throw"Applied makeEqual to objects with no spiritual equality"}if(analysis.first.spirit.type==="fraction"){mynumerneg=analysis.s2numer.neganalysis;hisnumerneg=analysis.s1numer.neganalysis;mydenomneg=analysis.s2denom.neganalysis;hisdenomneg=analysis.s1denom.neganalysis;safety=0;while(myneg.negs>hisneg.negs){tofloor=mynumerneg.totalnegs<hisnumerneg.totalnegs?0:1;toword=tofloor===0?"numer":"denom";_ref5=tofloor===0?[mynumerneg,hisnumerneg]:[mydenomneg,hisdenomneg],myfloorneg=_ref5[0],hisfloorneg=_ref5[1];if(true||myfloorneg.negs<hisfloorneg.negs){o["do"]("moveNegFromFracToFloorFac","movenegfromfractofloor",{aim:inneraddr.slice(0,-1),choices:[toword,"self"],selection:[[0]]});myfloorneg.negs++}myfloorneg.totalnegs++;inneraddr.pop();myneg.childnegs[tofloor]++;myneg.negs--;if(safety++>100){throw"WHILEBOOM"}}safety=0;while(myneg.negs<hisneg.negs){fromfloor=mynumerneg.totalnegs>hisnumerneg.totalnegs?0:1;fromword=fromfloor===0?"numer":"denom";_ref6=fromfloor===0?[mynumerneg,hisnumerneg]:[mydenomneg,hisdenomneg],myfloorneg=_ref6[0],hisfloorneg=_ref6[1];if(myfloorneg.negs>hisfloorneg.negs||o.deps.lookUp(o.target,inneraddr.concat(fromfloor)).type!=="product"){o["do"]("moveNegFromFloorFacToFrac","movenegfromfloortofrac",{aim:inneraddr,choices:[fromword,"self"],selection:[[0]]});myfloorneg.negs--}else{stealfromfac=findHole(hisfloorneg.childnegs,myfloorneg.childnegs);o["do"]("moveNegFromFloorFacToFrac","movenegfromfloortofrac",{aim:inneraddr,choices:[fromword,"facs"],selection:[[stealfromfac]]});myfloorneg.childnegs[stealfromfac]--}inneraddr.push(0);myfloorneg.totalnegs--;myneg.negs++}safety=0;while(mynumerneg.totalnegs!==hisnumerneg.totalnegs){_ref7=mynumerneg.totalnegs>hisnumerneg.totalnegs?[0,1]:[1,0],fromfloor=_ref7[0],tofloor=_ref7[1];_ref8=fromfloor===0?[mynumerneg,hisnumerneg,mydenomneg,hisdenomneg]:[mydenomneg,hisdenomneg,mynumerneg,hisnumerneg],myfromfloorneg=_ref8[0],hisfromfloorneg=_ref8[1],mytofloorneg=_ref8[2],histofloorneg=_ref8[3];fromword=fromfloor===0?"numer":"denom";if(myfromfloorneg.negs>hisfromfloorneg.negs||o.deps.lookUp(o.target,inneraddr.concat(fromfloor)).type!=="product"){takefrom="self";stealfromfac=0;myfromfloorneg.negs--}else{takefrom="facs";stealfromfac=findHole(hisfromfloorneg.childnegs,myfromfloorneg.childnegs);myfromfloorneg.childnegs[stealfromfac]--}if(mytofloorneg.negs<histofloorneg.negs||o.deps.lookUp(o.target,inneraddr.concat(tofloor)).type!=="product"){moveto="self";movetofac=0;mytofloorneg.negs++}else{moveto="facs";movetofac=findHole(mytofloorneg.childnegs,histofloorneg.childnegs);movetofac=(tofloor===0?analysis.s1numer:analysis.s1denom).reorder[movetofac];movetofac=(tofloor===0?analysis.s2numer:analysis.s2denom).reorder[movetofac];mytofloorneg.childnegs[movetofac]++}o["do"]("moveNegBetweenFloorsInFrac","movenegbetweenfloors",{aim:inneraddr,choices:[fromword,takefrom,moveto],selection:[[stealfromfac],[movetofac]]});if(fromfloor===0){mynumerneg.totalnegs--;mydenomneg.totalnegs++}else{mynumerneg.totalnegs++;mydenomneg.totalnegs--}if(safety++>100){throw"WHILEBOOM"}}}if((_ref9=analysis.first.spirit.type)==="sum"||_ref9==="product"||_ref9==="AND"||_ref9==="OR"){instr=[];for(p=_m=0,_ref10=analysis.second.spirit.objs.length;0<=_ref10?_m<_ref10:_m>_ref10;p=0<=_ref10?++_m:--_m){instr.push(analysis.first.reorder[analysis.second.reorder[p]])}oldnegmap=analysis.second.neganalysis.childnegs;newnegmap=function(){var _len2,_n,_results;_results=[];for(_n=0,_len2=instr.length;_n<_len2;_n++){pos=instr[_n];_results.push(oldnegmap[pos])}return _results}();analysis.second.neganalysis.childnegs=newnegmap;innervictimobj=o.deps.lookUp(o.target,inneraddr);newarr=[];_ref11=analysis.first.reorder;for(n=_n=0,_len2=_ref11.length;_n<_len2;n=++_n){aspir=_ref11[n];newarr[aspir]=innervictimobj.objs[analysis.second.reorder[n]]}rearrtool="rearrange"+{sum:"Terms",product:"Facs",AND:"InCond",OR:"InDis"}[analysis.first.spirit.type];o["do"](rearrtool,"reorderinglisttomatch",{aim:inneraddr,rearrange:newarr})}if(analysis.first.spirit.type==="product"){while(myneg.negs>hisneg.negs){moveto=findHole(myneg.childnegs,hisneg.childnegs);o["do"]("moveNegFromProdToFac","movingnegfromprodtofac",{aim:inneraddr.slice(0,-1),selection:[[moveto]]});myneg.negs--;myneg.childnegs[moveto]++;inneraddr.pop()}for(pos=_o=0,_ref12=myneg.childnegs.length;0<=_ref12?_o<_ref12:_o>_ref12;pos=0<=_ref12?++_o:--_o){while(myneg.childnegs[pos]>hisneg.childnegs[pos]){if(hisneg.negs>myneg.negs){o["do"]("moveNegFromFacToProd","movingnegfromfactoprod",{aim:inneraddr,selection:[[pos]]});inneraddr.push(0);myneg.negs++}else{moveto=findHole(myneg.childnegs,hisneg.childnegs);o["do"]("moveNegBetweenFacs","movingnegbetweenfacs",{aim:inneraddr,selection:[[pos],[moveto]]})}myneg.childnegs[pos]--}}}if(blueprint.type==="relation"){if(!o.deps.equal(o.deps.getSpiritObj(blueprint.objs[0]).spirit,o.deps.getSpiritObj(victim.objs[0]).spirit)){o["do"]("flipRelation","weturnrelationover",{aim:inneraddr})}}kidcount=o.deps.lookUp(o.target,blueprintaddr).objs.length;if(kidcount){for(childnum=_p=0;0<=kidcount?_p<kidcount:_p>kidcount;childnum=0<=kidcount?++_p:--_p){if(!o.deps.equal(o.deps.lookUp(o.target,blueprintaddr.concat(childnum)),o.deps.lookUp(o.target,victimaddr.concat(childnum)))){o["do"]("makeEqual","makesameposchildrensame",{hunt:[blueprintaddr.concat(childnum),victimaddr.concat(childnum)]})}}}}}return o}};rearrangeTerms={info:{name:"rearrangeTerms",effect:"rephrasing",example:{str:"x+y",rearrange:[y,x]},tags:["sum","commutativity"],lesson:"sum101"},target:{type:"sum"},perform:function(o){return{result:{type:o.target.type,objs:o.rearrange}}}};rearrangeFacs={info:{name:"rearrangeFacs",effect:"rephrasing",example:{str:"x*y",rearrange:[y,x]},tags:["product","commutativity"],lesson:"product101"},target:{type:"product"},perform:function(o){return{result:{type:o.target.type,objs:o.rearrange}}}};rearrangeInCon={info:{name:"rearrangeInCon",effect:"rephrasing",example:{str:"(x=3)and(y<2)",rearrange:[y,x]},tags:["logicand","commutativity"],lesson:"logic101"},target:{type:"AND"},perform:function(o){return{result:{type:o.target.type,objs:o.rearrange}}}};rearrangeInDis={info:{name:"rearrangeInDis",effect:"rephrasing",example:{str:"(x=3)or(y<2)",rearrange:[y,x]},tags:["logicor","commutativity"],lesson:"logic101"},target:{type:"OR"},perform:function(o){return{result:{type:o.target.type,objs:o.rearrange}}}};undefChildObjToUndef={info:{name:"undefChildObjToUndef",effect:"integrity",example:{str:"x+UNDEFINED+y",hunt:[[1]]},tags:["undefinedval"],lesson:"fraction101"},prints:{errors:["mustcontainundefined"],instructions:["huntundefchild"]},hunt:{instruction:"huntundefchild",max:1,type:"undefined"},auto:function(o){var diver,found;diver=function(obj,matchto,path){var child,pos,ret,_i,_len,_ref1;if(path==null){path=[]}if(o.deps.equal(obj,matchto)){return path}else if(obj.objs){_ref1=obj.objs;for(pos=_i=0,_len=_ref1.length;_i<_len;pos=++_i){child=_ref1[pos];ret=diver(child,matchto,path.concat(pos));if(ret){return ret}}}return false};found=diver(o.target,UNDEFINED);if(found&&!o.deps.equal(o.target,UNDEFINED)){return{hunt:[found]}}else{return Err("mustcontainundefined")}},perform:function(o){return{result:UNDEFINED,beforemarks:o.hunt,undef:true}}};decNumToFrac={info:{name:"decNumToFrac",effect:"simplifying",example:"1.23",uses:["divideByOne","integerifyDecNumsInFrac"],tags:["decimal","fraction"],lesson:"decimalnums",opposite:"fracToDecNum"},prints:{steps:["turntofrac","integerifyinfrac"]},target:"decnum",perform:function(o){o["do"]("divideByOne","turntofrac");o["do"]("integerifyDecNumsInFrac","integerifyinfrac");return o}};fracToDecNum={info:{name:"fracToDecNum",effect:"decimalifying",example:"5/2",tags:["decimal","fraction","approximate"],lesson:"decimalnums",opposite:"decNumToFrac"},prints:{errors:["TARnumermustbenum","TARdenommustbenum"]},target:{type:"fraction",validate:function(_arg){var denom,numer,_ref1;_ref1=_arg.target.objs,numer=_ref1[0],denom=_ref1[1];if(numer.type!=="number"){return Err("TARnumermustbenum",[0])}else if(denom.type!=="number"){return Err("TARdenommustbenum",[1])}else{return OK}}},perform:function(_arg){var d,denomval,n,numerval,res,_ref1,_ref2,_ref3;_ref1=_arg.target.objs,_ref2=_ref1[0],numerval=_ref2.val,_ref3=_ref1[1],denomval=_ref3.val;n=parseFloat(numerval);d=parseFloat(denomval);res=numerval/denomval;return{result:Num(res),approx:((""+res).split(".")[1]||"").length>10}}};fracWithNegNumToDecNum={info:{name:"fracWithNegNumToDecNum",effect:"decimalifying",example:"5/-2",tags:["decimal","fraction"],uses:["moveNegFromFloorFacToFrac","fracToDecNum"],lesson:"decimalnums"},prints:{errors:["TARnumerordenommustbeneg","TARonlyoneshouldbeneg","TARnumermustbenumornegnum","TARdenommustbenumornegnum"]},target:{type:"fraction",validate:function(_arg){var denom,numer,_ref1;_ref1=_arg.target.objs,numer=_ref1[0],denom=_ref1[1];if(!(numer.type==="number"||numer.type==="negation"&&numer.objs[0].type==="number")){return Err("TARnumermustbenumornegnum")}else if(!(denom.type==="number"||denom.type==="negation"&&denom.objs[0].type==="number")){return Err("TARdenommustbenumornegnum")}else if(!(numer.type==="negation"||denom.type==="negation")){return Err("TARnumerordenommustbeneg")}else if(numer.type==="negation"&&denom.type==="negation"){return Err("TARonlyoneshouldbeneg")}else{return OK}}},perform:function(o){o["do"]("moveNegFromFloorFacToFrac","movenegtofrac",{choices:[o.target.objs[0].type==="negation"?"numer":"denom","self"],selection:[[0]]});return o["do"]("fracToDecNum","thendecimalifyfrac",{aim:[0]})}};integerifyDecNumsInFrac={info:{name:"integerifyDecNumsInFrac",effect:"simplifying",example:"1.23/0.00456",uses:["prolongFraction","multiplication"],tags:["decimal","fraction"],lesson:"decimalnums"},prints:{steps:["prolongwithneeded","multnumer","multdenom"],errors:["TARnumerordenommustbedec","TARnumermustbenum","TARdenommustbenum"]},target:{type:"fraction",validate:function(o){var denom,denomdec,numer,numerdec,_ref1;_ref1=o.target.objs,numer=_ref1[0],denom=_ref1[1];if(!(numer.type==="number")){return Err("TARnumermustbenum",[0])}else if(!(denom.type==="number")){return Err("TARdenommustbenum",[1])}else{numerdec=numer.type==="number"&&parseFloat(numer.val)!==Math.floor(parseFloat(numer.val));denomdec=denom.type==="number"&&parseFloat(denom.val)!==Math.floor(parseFloat(denom.val));if(numerdec||denomdec){return OK}else{return Err("TARnumerordenommustbedec")}}}},perform:function(o){var denommult,needtomultwith,numermult;numermult=Math.pow(10,(o.target.objs[0].val.split(".")[1]||[]).length);denommult=Math.pow(10,(o.target.objs[1].val.split(".")[1]||[]).length);needtomultwith=""+Math.max(numermult,denommult);o["do"]("prolongFraction","prolongwithneeded",{argument:Num(needtomultwith)});o["do"]("multiplication","multnumer",{aim:[0]});o["do"]("multiplication","multdenom",{aim:[1]});return o}};if(typeof exports==="undefined"){exportTo=this.CATS.math}else{exportTo=exports}funcs={weight:weight,findAllPathsTo:findAllPathsTo,getStraightFacAddress:getStraightFacAddress,fracWithNegNumToDecNum:fracWithNegNumToDecNum,fracToDecNum:fracToDecNum,pathToChoice:pathToChoice,findPathTo:findPathTo,integerifyDecNumsInFrac:integerifyDecNumsInFrac,decNumToFrac:decNumToFrac,analyseVarKids:analyseVarKids,isKindredSpirits:isKindredSpirits,reorderInstruction:reorderInstruction,getSpiritObj:getSpiritObj,negStrip:negStrip,negAnalysis:negAnalysis,sortOrder:sortOrder,fullSortString:fullSortString,flatSortString:flatSortString,makeEqual:makeEqual,isWholeNumber:isWholeNumber,undefChildObjToUndef:undefChildObjToUndef,isOK:isOK,rearrangeTerms:rearrangeTerms,rearrangeFacs:rearrangeFacs,rearrangeInDis:rearrangeInDis,rearrangeInCon:rearrangeInCon,contains:contains,find:find,collapseStubList:collapseStubList,equal:equal,FindSubLists:FindSubLists,lookUp:lookUp,exchangeChild:exchangeChild};for(k in funcs){v=funcs[k];exportTo[k]=v}}).call(this);
(function(){var canLearn,canLearnLesson,checkTool,checkToolSingle,checkTools,count,countDeps,def,exportTo,forgetLesson,forgetTool,getCurrentDB,getLessonStatus,getNbrOpsInLesson,getToolStatus,haslesson,k,learnLesson,learnTool,lessondef,lessonid,lessons,link,linkdef,links,listToolsMissingLesson,loadeddb,maybeYellowLightTool,numberOfLearnedLessons,numberOfLearnedOps,remainingOpsInLesson,saveDB,signalLesson,toolname,tools,v,_i,_len,_ref,_ref1,_ref2;tools=typeof require==="undefined"?CATS.math:require("../code/tools");links=typeof require==="undefined"?CATS.texts.links:require("../build/texts_links");lessons=typeof require==="undefined"?CATS.school.lessons:require("../build/texts_lessons");console.log("WHAT THE EFFF heck heck heck",links,lessons);for(lessonid in lessons){def=lessons[lessonid];def.tools=[];console.log("......",lessonid,def.links);_ref=def.links||[];for(_i=0,_len=_ref.length;_i<_len;_i++){link=_ref[_i];linkdef=links[link];if((_ref1=linkdef.lessons)==null){linkdef.lessons=[]}linkdef.lessons.push(lessonid);console.log("added lesson",lessonid,"to word",link)}}haslesson=0;for(toolname in tools){def=tools[toolname];if(!(def.info&&def.info.lesson)){continue}haslesson++;if(!lessons[def.info.lesson]){throw"Unknown lesson!! Op "+toolname+", lesson "+def.info.lesson}lessons[def.info.lesson].tools=(lessons[def.info.lesson].tools||[]).concat(toolname)}loadeddb=null;getCurrentDB=function(){var currentname;if(!loadeddb){currentname=CATS.settings.currentpupil||"AEDEFAULT";loadeddb=JSON.parse(localStorage.getItem("ALGEBRAEPLORERPUPIL_"+currentname)||JSON.stringify({}));if(!loadeddb.format){loadeddb={format:1,lessons:{},tools:loadeddb}}}return loadeddb};saveDB=function(){var currentname,db;currentname=CATS.settings.currentpupil||"AEDEFAULT";db=getCurrentDB();return localStorage.setItem("ALGEBRAEPLORERPUPIL_"+currentname,JSON.stringify(db))};signalLesson=function(lessonid){console.log("LESSONSIGNAL",lessonid);return Backbone.trigger("updatelesson",lessonid)};learnTool=function(toolname){var db,dep,_j,_len1,_ref2,_results;db=getCurrentDB().tools;if(db[toolname]!==2){db[toolname]=2;saveDB();Backbone.trigger("learnedtool",toolname);if(tools[toolname].info.lesson){signalLesson(tools[toolname].info.lesson)}_ref2=tools[toolname].info.usedby||[];_results=[];for(_j=0,_len1=_ref2.length;_j<_len1;_j++){dep=_ref2[_j];_results.push(maybeYellowLightTool(dep))}return _results}};forgetTool=function(toolname,mem){var can,db,dbtools,dep,_j,_len1,_ref2,_results;if(!mem){mem={};mem[toolname]=true}db=getCurrentDB();dbtools=db.tools;if(dbtools[toolname]){can=canLearn(toolname);if(tools[toolname].info.uses&&can){dbtools[toolname]=1}else{delete dbtools[toolname]}Backbone.trigger(can?"forgottool":"losttouchoftool",toolname);lessonid=tools[toolname].info.lesson;if(lessonid){delete db.lessons[lessonid];signalLesson(lessonid)}saveDB();_ref2=tools[toolname].info.usedby||[];_results=[];for(_j=0,_len1=_ref2.length;_j<_len1;_j++){dep=_ref2[_j];if(!(dbtools[dep]&&!mem[dep]&&(tools[dep].info.circle||[]).indexOf(toolname)===-1)){continue}mem[dep]=true;_results.push(forgetTool(dep,mem))}return _results}};countDeps=function(toolname,mem){var count,db,dep,_j,_len1,_ref2;if(!mem){mem={};mem[toolname]=true}db=getCurrentDB().tools;count=0;_ref2=tools[toolname].info.usedby||[];for(_j=0,_len1=_ref2.length;_j<_len1;_j++){dep=_ref2[_j];if(!(db[dep]===2&&!mem[dep]&&(tools[dep].info.circle||[]).indexOf(toolname)===-1)){continue}mem[dep]=true;count+=1+countDeps(dep,mem)}return count};maybeYellowLightTool=function(toolname){var db,dep,tinfo,_j,_len1,_ref2;db=getCurrentDB().tools;tinfo=tools[toolname].info;if(db[toolname]===2||!tinfo.uses){return}console.log("Maybe yellowlight",toolname);_ref2=tinfo.uses;for(_j=0,_len1=_ref2.length;_j<_len1;_j++){dep=_ref2[_j];if(!(tinfo.circle&&tinfo.circle.indexOf(dep)!==-1)){if(db[dep]!==2){console.log("Nope, because",dep,db[dep]);return false}}}db[toolname]=1;saveDB();Backbone.trigger("qualifiedtool",toolname);if(tools[toolname].info.lesson){return signalLesson(tools[toolname].info.lesson)}};canLearn=function(toolname){var db,dep,tinfo,_j,_len1,_ref2;db=getCurrentDB().tools;tinfo=tools[toolname].info;_ref2=tinfo.uses||[];for(_j=0,_len1=_ref2.length;_j<_len1;_j++){dep=_ref2[_j];if(dep!==toolname&&db[dep]!==2&&!(tinfo.circle&&tinfo.circle.indexOf(dep)!==-1)){return false}}return true};getToolStatus=function(toolname){var db,_ref2;db=getCurrentDB().tools;if(!((_ref2=tools[toolname])!=null?_ref2.info:void 0)){return"green";throw"SCHOOL strange tool "+toolname}if(db[toolname]){return["FOOBAR","yellow","green"][db[toolname]]}else if((tools[toolname].info.uses||[]).length===0){return"yellow"}else{return"red"}};canLearnLesson=function(lessonid){var db,_j,_len1,_ref2;db=getCurrentDB().tools;_ref2=lessons[lessonid];for(_j=0,_len1=_ref2.length;_j<_len1;_j++){toolname=_ref2[_j];if(db[toolname]!==2){return false}}return true};remainingOpsInLesson=function(lessonid){var count,db,_j,_len1,_ref2;db=getCurrentDB().tools;count=0;_ref2=lessons[lessonid].tools;for(_j=0,_len1=_ref2.length;_j<_len1;_j++){toolname=_ref2[_j];if(db[toolname]!==2){count++}}return count};getNbrOpsInLesson=function(lessonid){return lessons[lessonid].tools.length};getLessonStatus=function(lessonid){var db,_j,_len1,_ref2;db=getCurrentDB();if(db.lessons[lessonid]){return"green"}else{if(!lessons[lessonid]){throw"Status query for unknown lesson: "+lessonid}_ref2=lessons[lessonid].tools;for(_j=0,_len1=_ref2.length;_j<_len1;_j++){toolname=_ref2[_j];if(db.tools[toolname]!==2){return"red"}}return"yellow"}};learnLesson=function(lessonid){var db;db=getCurrentDB();db.lessons[lessonid]=true;signalLesson(lessonid);return saveDB()};forgetLesson=function(lessonid){var db;db=getCurrentDB();delete db.lessons[lessonid];signalLesson(lessonid);return saveDB()};numberOfLearnedLessons=function(){var db,n;db=getCurrentDB();n=0;for(lessonid in lessons){if(db.lessons[lessonid]){n++}}return n};numberOfLearnedOps=function(){var db,n,tooldef,toolid;db=getCurrentDB().tools;n=0;for(toolid in tools){tooldef=tools[toolid];if(db[toolid]===2){n++}}return n};count=1;for(lessonid in lessons){lessondef=lessons[lessonid];lessondef.order=count++}checkTool=function(toolname,maxlesson,mem){var childtoolname,faults,tool,_j,_len1,_ref2,_ref3;if(mem==null){mem={}}mem[toolname]=true;tool=tools[toolname];if(maxlesson==null){maxlesson=tool.info.lesson}if(lessons[tool.info.lesson].order>lessons[maxlesson].order){return[toolname]}else{faults=[];_ref2=tool.info.uses||[];for(_j=0,_len1=_ref2.length;_j<_len1;_j++){childtoolname=_ref2[_j];if(!mem[childtoolname]&&((_ref3=tools[childtoolname].info)!=null?_ref3.lesson:void 0)&&(tool.info.circle||[]).indexOf(childtoolname)===-1){faults=faults.concat(checkTool(childtoolname,maxlesson,mem))}}return faults}};checkToolSingle=function(toolname){var childtoolname,max,ret,tool,_j,_len1,_ref2,_ref3,_ref4,_ref5;tool=tools[toolname];max=((_ref2=lessons[tool.info.lesson])!=null?_ref2.order:void 0)||0;ret=[];_ref3=tool.info.uses||[];for(_j=0,_len1=_ref3.length;_j<_len1;_j++){childtoolname=_ref3[_j];if(((_ref4=tools[childtoolname].info)!=null?_ref4.lesson:void 0)&&(tool.info.circle||[]).indexOf(childtoolname)===-1){if(((_ref5=lessons[tools[childtoolname].info.lesson])!=null?_ref5.order:void 0)>max){ret.push(childtoolname)}}}return ret};checkTools=function(){var n,res,tooldef,_ref2,_results;console.log("CHECKING TOOL LESSONS");_results=[];for(toolname in tools){tooldef=tools[toolname];if(!((_ref2=tooldef.info)!=null?_ref2.lesson:void 0)){continue}res=checkToolSingle(toolname);if(res.length){res=function(){var _j,_len1,_results1;_results1=[];for(_j=0,_len1=res.length;_j<_len1;_j++){n=res[_j];_results1.push(n+"("+tools[n].info.lesson+")")}return _results1}();_results.push(console.log("Error for tool",toolname,tooldef.info.lesson,res))}else{_results.push(void 0)}}return _results};listToolsMissingLesson=function(){var tooldef,_results;_results=[];for(toolname in tools){tooldef=tools[toolname];if(tooldef.info&&!tooldef.info.lesson){_results.push(console.log("No lesson for",toolname))}}return _results};if(typeof exports==="undefined"){exportTo=this.CATS.school}else{exportTo=exports}_ref2={numberOfLearnedOps:numberOfLearnedOps,numberOfLearnedLessons:numberOfLearnedLessons,getNbrOpsInLesson:getNbrOpsInLesson,listToolsMissingLesson:listToolsMissingLesson,checkTools:checkTools,canLearn:canLearn,maybeYellowLightTool:maybeYellowLightTool,signalLesson:signalLesson,remainingOpsInLesson:remainingOpsInLesson,countDeps:countDeps,lessons:lessons,getToolStatus:getToolStatus,learnTool:learnTool,forgetTool:forgetTool,getCurrentDB:getCurrentDB,getLessonStatus:getLessonStatus,learnLesson:learnLesson,forgetLesson:forgetLesson,haslesson:haslesson};for(k in _ref2){v=_ref2[k];exportTo[k]=v}}).call(this);
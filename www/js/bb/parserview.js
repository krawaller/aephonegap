(function(){var examples;examples=typeof require==="undefined"?this.CATS.texts.examples:require("../app/texts_examples");CATS.bb.ParserView=CATS.bb.BaseView.extend({localizeid:"parser",category:"calc",events:{"click .buttoncalculate":"enterMath","focus .textfield":"focusTextField","blur .textfield":"blurTextField","keyup .textfield":"inputKeypress","click .calcbutton":"enterMath","click .textclearerbtn":"clearInput"},className:"viewbox parserview",clearInput:function(e){var me;if(this.ui.textfield.val()){me=this;setTimeout(function(){me.ui.textfield.val("").focus();me.$el.removeClass("notempty");return me.analyzeMathEntry("")},200)}e.preventDefault();return false},updateClearBtn:function(){return this.$el[this.ui.textfield.val()===""?"removeClass":"addClass"]("notempty")},analyzeMathEntry:function(txt,force){var me;me=this;if(force){this.analyzeMathEntryDo(txt)}if(txt!==this.before){this.before=txt;clearTimeout(this.timeout);return this.timeout=setTimeout(function(){return me.analyzeMathEntryDo(txt)},200)}},analyzeMathEntryDo:function(txt){var e,err,lang,mathml,me,o;console.log("MATHENTRY",txt);try{o=CATS.app.parseExpression(txt,CATS.settings);mathml=CATS.app.mathmlprinter(o,[],[],true,CATS.settings,true);lang=CATS.settings.lang;this.ui.math.empty();err=CATS.app.check(o);if(o.type==="void"){console.log("ingenting!",txt,this.ui.inputdescription.html(CATS.texts.ui.mathview.noentry[lang]));if(err&&err[0]==="noparse"){return this.setError(err[0],err[1])}}else{this.ui.math.html(mathml);me=this;this.typeset(this.ui.math,function(){return me.ui.math.append(me.reportLink("interpret",JSON.stringify({input:txt,obj:o})))});this.ui.inputdescription.html(CATS.texts.ui.mathview.enteredbeginning[lang]+" "+CATS.texts.processText(CATS.texts.describe(o,lang),lang)+this.reportLink("describe",JSON.stringify({obj:o})));if(err&&err[0]==="noparse"){return this.setError(err[0],err[1])}else{if(this.showingerror){this.showingerror=false;clearTimeout(this.errortimeout);return this.ui.errormsg.fadeOut("fast")}}}}catch(_error){e=_error;return this.trigger("explosion",{str:txt,obj:o,error:e})}},focusTextField:function(){var me;this.ui.errormsg.hide();this.ui.introhelptext.hide();Backbone.trigger("focusTextField");this.analyzeMathEntry(this.ui.textfield.val());this.beforetext=this.ui.textfield.val();this.updateClearBtn();me=this;setTimeout(function(){var _base;return typeof(_base=me.ui.textfield.get(0)).select==="function"?_base.select():void 0});return CATS.parser=true},blurTextField:function(){this.fixIntro();return Backbone.trigger("blurTextField")},blurFix:function(){return CATS.parser=false},initialize:function(o){var def,headline,list,name,x,_i,_len;this.instruction=(o!=null?o.instruction:void 0)||"enterexpressiontosimplify";_.bind(this.analyzeMathEntryDo,this);_.bind(this.doMath,this);this.listenTo(Backbone,"updatelesson",this.fixIntro);this.listenTo(Backbone,"inputparsertext",this.remoteInput);this.listenTo(Backbone,"blurTextField",this.blurFix);this.constructor.__super__.initialize.apply(this,arguments);this.examples={};for(headline in examples){def=examples[headline];for(name in def){list=def[name];if(!(name!=="headline")){continue}console.log("BUILDING",headline,name,list);for(_i=0,_len=list.length;_i<_len;_i++){x=list[_i];this.examples[x]=true}}}console.log("DID ALL EXAMPLES",this.examples);CATS.history=JSON.parse(localStorage.getItem("ALGEBRAEXPLORERCALCHIST")||JSON.stringify({all:{}}));Backbone.trigger("newcalc");Backbone.trigger("updatedhistory");return this.DESCRIPTION="expression"},setHistory:function(str){var datestr,daystr,monthstr,now;if(!this.examples[str]&&!CATS.history.all[str]){now=new Date;monthstr=now.getMonth()+1;daystr=now.getDate();if(monthstr<10){monthstr="0"+monthstr}if(daystr<10){daystr="0"+daystr}datestr=now.getFullYear()+"-"+monthstr+"-"+daystr;if(!CATS.history[datestr]){CATS.history[datestr]=[]}CATS.history[datestr].push(str);CATS.history.all[str]=true;localStorage.setItem("ALGEBRAEXPLORERCALCHIST",JSON.stringify(CATS.history));return Backbone.trigger("updatedhistory")}},render:function(){this.setContent(CATS.cache.templates["#parsertemplate"]);this.setTitle("parserheadline",!this.noroot);this.setUI("parserinput","textfield","errormsg","math","struct","cancelbutton","calcbutton","inputdescription","newcalcbutton","introhelptext");this.ui.errormsg.hide();this.specialLoc();this.fixIntro();return this},fixIntro:function(){if(this.noroot||this.ui.textfield.val()||"green"===CATS.school.getLessonStatus("realappintro")){return this.ui.introhelptext.hide()}else{return this.ui.introhelptext.show()}},specialLoc:function(){this.ui.textfield.attr("placeholder",CATS.texts.ui.parser.inputplaceholder[CATS.settings.lang]);console.log("LOCSPEC",CATS.settings.lang);this.analyzeMathEntry(this.ui.textfield.val(),true);this.old=this.ui.calcbutton.html();return this},showItem:function(text){this.ui.textfield.val(text);return this.focusTextField()},remoteInput:function(text,source){this.ui.textfield.val(text);console.log("REMOTE INPUT",text,source,this.ui.textfield,this.ui.textfield.val());return this.focusTextField()},setError:function(errorid,errordata){var me;console.log("SETTING ERROR",errorid,this.ui.errormsg);this.ui.errormsg.html(this.getText(["ui","parser","error"+errorid,CATS.settings.lang],true,false,true)+(errordata?" '"+errordata+"'":""));if(this.showingerror){clearTimeout(this.errortimeout)}else{this.showingerror=true;this.ui.errormsg.fadeIn("fast")}me=this;return this.errortimeout=setTimeout(function(){me.showingerror=false;return me.ui.errormsg.fadeOut("fast")},2e3)},inputKeypress:function(e){console.log("KKKKK",e.keyCode,e.charCode);if(e.keyCode===13){return this.enterMath()}else{this.updateClearBtn();return this.analyzeMathEntry(this.ui.textfield.val())}},enterMath:function(e,source){var error,me,o,obj,str;this.ui.calcbutton.blur();this.ui.textfield.blur();this.ui.errormsg.empty();str=this.ui.textfield.val();if(str===""){console.log("WHAT THE EFFF",this.ui.textfield);return this.setError("empty")}else{obj=CATS.app.parseExpression(str,CATS.settings);this.lastentry=str;error=CATS.app.check(obj);if(error){console.log("ERROR",error);return this.setError(error[0],error[1])}else{this.old=this.ui.calcbutton.html();this.ui.calcbutton.css("min-width",this.ui.calcbutton.outerWidth());this.ui.calcbutton.html(this.getLoadingHTML());this.ui.calcbutton.addClass("disabled");o=new CATS.math.Carrier({target:obj});o.simplifiers=CATS.math.simplifiers;me=this;return setTimeout(function(){return me.doMath(o,source,str,true)},150)}}},doMath:function(o,source,str,byuser){var calcerror,e,me,result,_ref;try{result=CATS.math.simplifyAndDecimalify(o,CATS.math);console.log("DID SIMPLDEC",result)}catch(_error){e=_error;this.ui.calcbutton.html(this.old);this.ui.calcbutton.removeClass("disabled");calcerror=e;this.trigger("explosion",{input:str,error:e,why:byuser?"simpl":"example"})}if(calcerror){this.ui.calcbutton.html(this.old);return this.ui.calcbutton.removeClass("disabled")}else if(result.toshow==="none"){this.ui.calcbutton.html(this.old);this.ui.calcbutton.removeClass("disabled");return this.setError("cannotsimplify")}else{if(byuser){this.setHistory(str)}if(result.toshow==="onlysimpl"){result=result.simpl}if(result.toshow==="onlydec"){result=result.dec}if((_ref=result.because)==null){result.because=result.who||source}result.inputstring=str;console.log("TOSHOW",result);this.ui.calcbutton.html(this.old);this.ui.calcbutton.removeClass("disabled");me=this;if(result.toshow==="both"){return setTimeout(function(){return me.$el.trigger("showcalcresult",{result:result.simpl,dec:result.dec})},10)}else{return setTimeout(function(){return me.$el.trigger("showcalcresult",{result:result})},10)}}}})}).call(this);
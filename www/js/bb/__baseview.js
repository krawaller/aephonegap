(function(){var icon,txticon,typeset,_ref,__slice=[].slice,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};_ref=typeof require==="undefined"?this.CATS.app.helpers:require("./helpers"),icon=_ref.icon,txticon=_ref.txticon,typeset=_ref.typeset;CATS.bb.BaseView=Backbone.View.extend({toolLinkAware:function(){this.listenTo(Backbone,"learnedtool",this.toolToGreen);this.listenTo(Backbone,"forgottool",this.toolToYellow);this.listenTo(Backbone,"losttouchoftool",this.toolToRed);return this.listenTo(Backbone,"qualifiedtool",this.toolToYellow)},killMeFromRoot:function(){this.$el.addClass("sequencehiddenright");return setTimeout(_.bind(this.cleanup,this),500)},lessonLinkAware:function(){return this.listenTo(Backbone,"updatelesson",this.updateLessonLink)},updateLessonLink:function(l){return this.$(".lessonlink[linkto='"+l+"']").html(this.lessonLink(l,true))},lessonLink:function(lessonid,fill){var completed,content,count,lessondef,tool,_i,_len,_ref1;lessondef=CATS.school.lessons[lessonid];count={red:0,green:0,yellow:0};_ref1=lessondef.tools;for(_i=0,_len=_ref1.length;_i<_len;_i++){tool=_ref1[_i];count[CATS.school.getToolStatus(tool)]++}completed="green"===CATS.school.getLessonStatus(lessonid);content="<span "+(completed?"class='completedlesson'":"")+">"+lessondef.headline[CATS.settings.lang]+"<span class='redcount'>"+count.red+"</span><span class='yellowcount'>"+count.yellow+"</span><span class='greencount'>"+count.green+"</span></span>";if(fill){return content}else{return"<a href='#' class='davidlink lessonlink' linkto='"+lessonid+"'>"+content+"</a>"}},wordLink:function(word,lang){if(lang==null){lang=CATS.settings.lang}return"<a href='#' class='davidlink wordlink' linkto='"+word+"'>"+CATS.texts.links[word].headline[lang]+"</a>"},infoLink:function(info,lang){if(lang==null){lang=CATS.settings.lang}return"<a href='#' class='davidlink infolink' linkto='"+info+"'>"+CATS.texts.info[info].headline[lang]+"</a>"},toolToGreen:function(t){return this.$(".toollink[linkto='"+t+"']").removeClass("red yellow").addClass("green")},toolToRed:function(t){return this.$(".toollink[linkto='"+t+"']").removeClass("green yellow").addClass("red")},toolToYellow:function(t){return this.$(".toollink[linkto='"+t+"']").removeClass("red green").addClass("yellow")},updateAllMyToolLinks:function(){return this.$(".toollink").each(function(i,el){var tname;tname=$(el).attr("linkto");if(tname){return $(el).removeClass("red yellow green").addClass(CATS.school.getToolStatus(tname))}else{return console.log("\nThat's weird, I have a toollink with no linkto",el)}})},escapeStr:function(str){var entityMap;entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return String(str).replace(/[&<>"'\/]/g,function(s){return entityMap[s]})},identifyYourself:function(){return console.log("PRESENT! ",this.me,this)},getLoadingHTML:function(lang){return"<div class='loader'>"+this.txticon("clock")+"</div>"},getUnderConstructionHTML:function(lang){return"<div class='underconstruction'>"+txticon("construction_cone",true)+" under construction "+txticon("construction_cone",true)+"</div>"},initialize:function(o){var name,view,_ref1;this.me="UNKNOWN";_ref1=CATS.bb;for(name in _ref1){view=_ref1[name];if(view===this.constructor){this.me=name}}return this.listenTo(Backbone,"showofhands",this.identifyYourself)},kill:function(){return this.cleanup()},icon:icon,txticon:txticon,drawPreRenderedPart:function(selector,el,callback){var pre;el=$(el);pre=$("#PRERENDER").find(selector);if(pre.length===0){throw"COULDN'T FIND PRERENDER "+selector}if(CATS.cache.prerenderedparts[selector]){el.html(pre.html());if(callback){return callback()}}else{el.html(this.getLoadingHTML(CATS.settings.lang));return typeset(pre,function(){el.html(pre.html());CATS.cache.prerenderedparts[selector]=true;if(callback){return callback()}})}},cleanup:function(){var view,_i,_len,_ref1;this.$el.remove();_ref1=this.childViews||[];for(_i=0,_len=_ref1.length;_i<_len;_i++){view=_ref1[_i];view.kill()}return this.remove()},setText:function(sel,path,pure,process,neverprocess){var text;text=this.getText(path,pure,process,neverprocess);return this.$(sel).html(text)},getText:function(path,pure,alwaysprocess,dontprocess){var cache,key,p,reporter,text,_i,_len;reporter="<span class='textreport' path='"+path.join("-")+"'>!</span>";cache=CATS.cache.texts;key=path.join("|");text=cache[key];if(dontprocess||!text){text=CATS.texts;for(_i=0,_len=path.length;_i<_len;_i++){p=path[_i];text=text[p];if(text===void 0){return"** MISSING: "+path.join("-")+" **"+reporter}}if(!dontprocess){text=cache[key]=CATS.texts.processText(text,CATS.settings.lang)}}if(alwaysprocess){text=CATS.texts.processText(text,CATS.settings.lang)}if(!pure){return text+reporter}else{return text}},setUI:function(){var classes,iamme,name,search,_i,_len,_results;classes=1<=arguments.length?__slice.call(arguments,0):[];this.ui=this.ui||{};_results=[];for(_i=0,_len=classes.length;_i<_len;_i++){name=classes[_i];search=this.$("."+name);if(!search.length){console.log("WARNING! couldn't find ui",name,this.$el,this.$("."+name),this.$el.find("."+name))}this.ui[name]=this.$("."+name);iamme=this;_results.push(this.ui[name].setText=function(n,me){return function(path,pure,always,neverprocess){if(typeof path==="string"){path=["ui",me.localizeid,path,CATS.settings.lang]}return me.ui[n].html(me.getText(path,pure,always,neverprocess))}}(name,this))}return _results},setUIprocessTexts:function(){var classes,name,_i,_len,_results;classes=1<=arguments.length?__slice.call(arguments,0):[];this.processUIs=(this.processUIs||[]).concat(classes);_results=[];for(_i=0,_len=classes.length;_i<_len;_i++){name=classes[_i];this.setUI(name);_results.push(this.ui[name].html(CATS.texts.processText(this.ui[name].html(),CATS.settings.lang)))}return _results},toolLink:function(toolname,lang,nolink,extraclasses){var color,complexicon,def,name,textdef;if(lang==null){lang=CATS.settings.lang}def=CATS.math[toolname];if(!(def!=null?def.info:void 0)){console.log("ALERT ALERT! No tool found: "+toolname)}complexicon=def.info.uses?"tags":"tag";textdef=CATS.texts.tools[toolname][lang];name=typeof textdef!=="string"?textdef.name:textdef;color=CATS.school.getToolStatus(toolname);if(nolink){return"<span class='toollink nolink "+color+" "+(extraclasses||[]).join(" ")+"'>"+name+"</span>"}else{return"<a href='#' class='toollink davidlink "+color+" "+(extraclasses||[]).join(" ")+"' linkto='"+toolname+"'>"+name+"</a>"}},localize:function(){var lang,textid,ui;if(!this.iamlisteingtolangchange){this.listenTo(Backbone,"setlang",this.localize);this.iamlisteingtolangchange=true}lang=CATS.settings.lang;ui=CATS.texts.ui[this.localizeid];for(textid in ui){this.setText("."+textid,["ui",this.localizeid,textid,lang],textid.match(/button|btn|alternative|bug/),__indexOf.call(this.processUIs||[],textid)>=0,this.noprocess||textid.match(/button|btn|alternative|headline/))}if(this.localizeSpecial){this.localizeSpecial()}return this},typeset:typeset,drawToolExample:function(toolname,lang,beforenode,afternode){var node;node=$("#EXAMPLE"+toolname).find("."+lang);$(beforenode).html(node.children().eq(0).html());return $(afternode).html(node.children().eq(1).html())},oldDrawToolExample:function(toolname,lang,beforenode,afternode){var carrier,def,e,exampleinput,exhtml,finish,step;def=CATS.math[toolname];if(!def){throw"NO EXAMPLETOOL "+toolname}finish=function(){var node;CATS.cache.examples[toolname]=true;node=$("#TOOLEX"+toolname).find("."+lang);$(beforenode).html(node.children().eq(0).html());return $(afternode).html(node.children().eq(1).html())};if(CATS.cache.examples[toolname]){return finish()}else{$(beforenode).html("...drawing...");$(afternode).html("...drawing...");exampleinput=CATS.math.exampleInput(def.info.example);carrier=new CATS.math.Carrier({target:exampleinput.target});try{carrier["do"](toolname,"example",exampleinput)}catch(_error){e=_error;console.log("FAULTY EXAMPLE: ",toolname,exampleinput);throw e}step=carrier.steps[0];exhtml=$("<div id='TOOLEX"+toolname+"'>\n	<div class='en'>\n		<div class='mathobj' data-obj='"+JSON.stringify(step.before)+"'>"+CATS.app.mathmlprinter(step.before,[],step.beforemarks||[],true,{lang:"en"})+"</div>\n		<div class='mathobj' data-obj='"+JSON.stringify(step.after)+"'>"+CATS.app.mathmlprinter(step.after,[],step.aftermarks||[],true,{lang:"en"})+"</div>\n	</div><div class='sv'>\n		<div class='mathobj' data-obj='"+JSON.stringify(step.before)+"'>"+CATS.app.mathmlprinter(step.before,[],step.beforemarks||[],true,{lang:"sv"})+"</div>\n		<div class='mathobj' data-obj='"+JSON.stringify(step.after)+"'>"+CATS.app.mathmlprinter(step.after,[],step.aftermarks||[],true,{lang:"sv"})+"</div>\n	</div>\n</div>");$("#mathprerender").append(exhtml);return this.typeset(exhtml,finish)}},drawToolListForWord:function(tag,lang,simplenode,complexnode){var container,example,finish,kind,l,li,list,num,pre,tool1,tool2,toolname,tools,ul,word,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref1,_ref2,_ref3,_ref4;finish=function(){var node;CATS.cache.lists[tag]=true;node=$("#TAGTOOLLIST"+tag).find("."+lang);$(simplenode).html(node.children().eq(0).html());return $(complexnode).html(node.children().eq(1).html())};if(CATS.cache.lists[tag]){return finish()}else{$(simplenode).html("...drawing...");$(complexnode).html("...drawing...");pre=$("<div id='TAGTOOLLIST"+tag+"'>");$("#mathprerender").append(pre);_ref1=["sv","en"];for(_i=0,_len=_ref1.length;_i<_len;_i++){l=_ref1[_i];container=$("<div class='"+l+"'>");pre.append(container);word=CATS.texts.links[tag].headline[l];_ref2=["basic","complex"];for(_j=0,_len1=_ref2.length;_j<_len1;_j++){kind=_ref2[_j];list=$("<div>");container.append(list);tools=((_ref3=CATS.texts.toolTagIndex[tag])!=null?_ref3[kind]:void 0)||[];num=0;if(tools.length===0){list.append("<p>"+CATS.texts.ui.word["therearenotools"+kind][l]+" "+word+".</p>")}else{for(_k=0,_len2=tools.length;_k<_len2;_k++){toolname=tools[_k];num+=toolname.split("|").length}if(num===1){list.append("<p>"+CATS.texts.ui.word["thereisonetool"+kind][l]+" "+word+".</p>")}else{list.append("<p>"+CATS.texts.ui.word["therearemanytools"+kind][l].replace("%s",CATS.texts.numberStr(num,l))+" "+word+".</p>")}ul=$("<ul>");list.append(ul);for(_l=0,_len3=tools.length;_l<_len3;_l++){toolname=tools[_l];_ref4=toolname.split("|"),tool1=_ref4[0],tool2=_ref4[1];li=$("<li>"+this.toolLink(tool1,l)+(tool2?CATS.texts.ui.word.andalso[l]+this.toolLink(tool2,l):"")+"</li>");ul.append(li);example=$("<div class='clearfix clear-both opsection'>\n	<div class='opcontainer'>\n		<div class='beforecontainer oppartcontainer'></div>\n		<div class='arrow'>"+(tool2?"&harr;":"&rarr;")+"</div>\n		<div class='aftercontainer oppartcontainer'></div>\n	</div>\n</div>");li.append(example);this.drawToolExample(tool1,lang,example.find(".beforecontainer"),example.find(".aftercontainer"))}}}}return this.typeset(pre,finish)}}})}).call(this);